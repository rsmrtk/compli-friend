#!/bin/bash

# rebuild-docker.sh
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Docker –æ–±—Ä–∞–∑—É
# –ó—É–ø–∏–Ω—è—î —Å—Ç–∞—Ä–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤–∏–¥–∞–ª—è—î —Å—Ç–∞—Ä–∏–π –æ–±—Ä–∞–∑, —Ç–∞ –±—É–¥—É—î –Ω–æ–≤–∏–π –∑ .env

set -e  # –ó—É–ø–∏–Ω–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ù–∞–∑–≤–∞ –æ–±—Ä–∞–∑—É —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
IMAGE_NAME="martun5/comply-friend:v1.0.0"
CONTAINER_NAME="compli-friend-bot"

echo -e "${YELLOW}üîÑ –ü–æ—á–∏–Ω–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Docker –æ–±—Ä–∞–∑—É...${NC}"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ .env —Ñ–∞–π–ª—É
if [ ! -f .env ]; then
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞: .env —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì .env —Ñ–∞–π–ª –∑–Ω–∞–π–¥–µ–Ω–æ${NC}"

# –ó—É–ø–∏–Ω–∫–∞ —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo -e "${YELLOW}‚èπÔ∏è  –ó—É–ø–∏–Ω—è—î–º–æ —Ç–∞ –≤–∏–¥–∞–ª—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...${NC}"
docker stop $CONTAINER_NAME 2>/dev/null || echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π${NC}"
docker rm $CONTAINER_NAME 2>/dev/null || echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ${NC}"

# –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –æ–±—Ä–∞–∑—É
echo -e "${YELLOW}üóëÔ∏è  –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π –æ–±—Ä–∞–∑...${NC}"
docker rmi -f $IMAGE_NAME 2>/dev/null || echo -e "${YELLOW}‚ö†Ô∏è  –û–±—Ä–∞–∑ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ${NC}"

# –û—á–∏—â–µ–Ω–Ω—è –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö –æ–±—Ä–∞–∑—ñ–≤
echo -e "${YELLOW}üßπ –û—á–∏—â–∞—î–º–æ –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –æ–±—Ä–∞–∑–∏...${NC}"
docker image prune -f

# –ó–±—ñ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É
echo -e "${YELLOW}üî® –ë—É–¥—É—î–º–æ –Ω–æ–≤–∏–π –æ–±—Ä–∞–∑...${NC}"
docker build -t $IMAGE_NAME .

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ –∑–±—ñ—Ä–∫–∏
if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì –û–±—Ä–∞–∑ —É—Å–ø—ñ—à–Ω–æ –∑—ñ–±—Ä–∞–Ω–æ${NC}"
else
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±—ñ—Ä—Ü—ñ –æ–±—Ä–∞–∑—É!${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑ .env —Ñ–∞–π–ª–æ–º
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...${NC}"
docker run -d \
    --name $CONTAINER_NAME \
    --env-file .env \
    --restart unless-stopped \
    $IMAGE_NAME

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
echo -e "${YELLOW}üìä –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å...${NC}"
docker ps | grep $CONTAINER_NAME

echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–∑ –æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ${NC}"

# –ü–æ–∫–∞–∑—É—î–º–æ –ª–æ–≥–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ - –∑–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —è–∫—â–æ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
echo -e "${YELLOW}üìã –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:${NC}"
docker logs --tail=20 $CONTAINER_NAME
